# 1장. 스프링 개발 환경 구축
## ch04. MyBatis의 스프링 연동
- MyBatis의 장점
    - 자동으로 Connection close() 가능
    - MyBatis 내부적으로 PreparedStatement 처리
    - #{prop}와 같이 속성을 지정하면 내부적으로 자동 처리
    - 리턴 타입을 지정하는 경우 자동으로 객체 생성 및 ResultSet 처리
    - 기존의 SQL을 그대로 활용 가능
    - 진입장벽이 낮음
-----------------
- MyBatis 라이브러리 추가
    - pom.xml
    ```xml
    <!-- mybatis 라이브러리 추가 -->
    <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.4.6</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>1.3.2</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-tx</artifactId>
        <version>${org.springframework-version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>${org.springframework-version}</version>
    </dependency>
    ```
- SQLSessionFactory
    - SQLSession을 통해 Connection을 생성하거나 원하는 SQL을 전달하고, 결과를 리턴 받는 구조로 작성하게 됨
    - root-context.xml
    ```xml
    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
		<property name="dataSource" ref="dataSource"></property>
	</bean>
    ```
- Mapper
    - SQLSessionFactory를 이용해서 코드를 작성해도 직접 Connection을 얻어서 JDBC 코딩이 가능하지만 좀 더 편하게 사용하기 위해 Mapper 사용
    - SQL을 어떻게 처리할 것인지 별도의 설정을 분리해 주고, 자동으로 처리되는 방식 이용
    - 즉, SQL과 그에 대한 처리를 지정하는 역할을 함
    - Spring을 이용하는 경우에는 Mapper를 XML과 인터페이스 + 어노테이션의 형태로 작성 가능
-------------
- Mapper 인터페이스
    - TimeMapper.java
    ```java
    package org.zerock.mapper;

    import org.apache.ibatis.annotations.Select;

    public interface TimeMapper {

        @Select("SELECT sysdate FROM dual")
        public String getTime();

    }
    ```
    - MyBatis가 동작할 때 Mapper를 인식할 수 있도록 설정
    - root-context.xml
    
        <img width="50%" src="./img/1_4.png">
    
    ```xml
	<mybatis-spring:scan base-package="org.zerock.mapper"/>
    ```
    - TimeMapperTests.java
    ```java
    package org.zerock.persistence;

    import org.junit.Test;
    import org.junit.runner.RunWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
    import org.zerock.mapper.TimeMapper;

    import lombok.Setter;
    import lombok.extern.log4j.Log4j;

    @RunWith(SpringJUnit4ClassRunner.class)
    @ContextConfiguration("file:src/main/webapp/WEB-INF/spring/root-context.xml")
    /*
    * JAVA 설정의 경우
    * @ContextConfiguration(classes = {org.zerock.config.RootConfig.class})
    */
    @Log4j
    public class TimeMapperTests {
        @Setter(onMethod_ = @Autowired)
        private TimeMapper timeMapper;
        
        @Test
        public void testGetTime() {
            log.info(timeMapper.getClass().getName());
            log.info(timeMapper.getTime());
        }
    }
    ```
------------
- XML 매퍼와 같이 쓰기
    - MyBatis를 이용해서 SQL을 처리할 때 어노테이션을 이용하는 방식이 압도적으로 편리함
    - 하지만, SQL이 복잡하거나 길어지는 경우 XML을 이용하는 방식을 권장
    - Mapper 인터페이스와 XML 파일의 이름을 동일하게 하는 것이 가독성에 좋음
- id 속성과 메서드의 이름과 동일하게, resultType은 인터페이스에 선언된 메서드의 리턴 타입과 동일하게 작성
- TimeMapper.xml
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="org.zerock.mapper.TimeMapper">

        <select id="getTime2" resultType="string">
            SELECT SYSDATE FROM dual
        </select>
        
    </mapper>
    ```
- TimeMapperTests.java
    ```java
    package org.zerock.persistence;

    import org.junit.Test;
    import org.junit.runner.RunWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
    import org.zerock.mapper.TimeMapper;

    import lombok.Setter;
    import lombok.extern.log4j.Log4j;

    @RunWith(SpringJUnit4ClassRunner.class)
    @ContextConfiguration("file:src/main/webapp/WEB-INF/spring/root-context.xml")
    /*
    * JAVA 설정의 경우
    * @ContextConfiguration(classes = {org.zerock.config.RootConfig.class})
    */
    @Log4j
    public class TimeMapperTests {
        @Setter(onMethod_ = @Autowired)
        private TimeMapper timeMapper;
        
        @Test
        public void testGetTime() {
            log.info("getTime2!!");
            log.info(timeMapper.getTime2());
        }
    }
    ```